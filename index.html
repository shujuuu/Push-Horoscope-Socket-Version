<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <script src="https://www.gstatic.com/firebasejs/7.12.0/firebase-app.js"></script>
    <!-- <script src="https://www.gstatic.com/firebasejs/7.12.0/firebase-database.js"></script> -->
    <script src="https://www.gstatic.com/firebasejs/7.12.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.12.0/firebase-analytics.js"></script>
    <script src='https://apis.google.com/js/api.js' type="text/javascript"></script>
    <link href="https://fonts.googleapis.com/css?family=Crimson+Text&display=swap" rel="stylesheet">
    <!-- <script src='/js/push.min.js'></script>
    <script src='/js/serviceWorker.min.js'></script> -->
    <!-- <script src='/js/hello.js'></script> -->
    <script src="/socket.io/socket.io.js"></script>


    <title>Push Horoscope</title>
</head>

<body>
    <!-- <button id='timeStampBtn'>Click and store to firebase</button> -->
    <!-- <button id='loginCalendar'>Login Another Calendar</button> -->
    <img id='original' src="" alt="">
    <div id='audio'></div>
    <!-- <p>Loading your fortune...</p> -->
    <div id='fortune' class='txtCenter'>
        <div class='section'>
            <p>Today is</p>
            <p id='date' class='inline'></p>
        </div>
        <div class='section'>
            <p>You have scheduled</p>
            <div id='event' class='inline'></div>
        </div>
        <div id='performance' class='section'>
            <p>Expected level of performance is</p>
        </div>
        <div id='dos' class='section'>
            <p>Try</p>
        </div>

        <div id='donts' class='section'>
            <p>Refrain from</p>
        </div>
    </div>

</body>
<script>
    // let result = {
    //     cleanToday: '2020-03-30',
    //     classEvents: ['2020-03-30T21:30:00-04:00 - demo purpose',
    //         '2020-03-30T23:00:00-04:00 - trial'
    //     ],
    //     matchGood: ['+ Demolition'],
    //     matchBad: ['+ Blessing of religious artifacts',
    //         '+ worship',
    //         '+ engagement',
    //         '+ marriage',
    //         '+ sign agreement',
    //         '+ business',
    //         '+ open for business',
    //         '+ house warming',
    //         '+ travel',
    //         '+ assume office'
    //     ],
    //     hours: ['Average',
    //         'Very Bad ',
    //         'Good',
    //         'Very Bad',
    //         'Average',
    //         'Average',
    //         'Good',
    //         'Average',
    //         'Bad',
    //         'Average',
    //         'Average',
    //         'Average'
    //     ],
    //     score: -1
    // }
    // let timeRegExp = /\d{2}:\d{2}/;
    // // console.log(result.classEvents);
    // result.classEvents.forEach(element => {
    //     //create p
    //     console.log(element);
    //     console.log(timeRegExp.exec(element)[0]);
    // })

    var socket = io.connect('');
    socket.on('connect', function () {
        console.log("Connected");
    });

    let dos = document.getElementById('dos');
    let donts = document.getElementById('donts');
    let performance = document.getElementById('performance');
    // let comment = document.getElementById('comment');
    let event = document.getElementById('event')
    let timeRegExp = /\d{2}:\d{2}/;
    let titleRegExp = /\s\w+/;
    let date = document.getElementById('date');
    let stringTitle = [];
    let stringTime = [];

    socket.on('activities', function (list) {
        // console.log(list);
        //put date into html        
        date.innerHTML = list.cleanToday;

        //put events list into html
        list.classEvents.forEach(element => {
            //get clean title
            let startTitleIndex = 28;
            let cleanTitle = element.slice(startTitleIndex);
            let spanTitle = document.createElement("span");
            let nodeTitle = document.createTextNode(cleanTitle);
            spanTitle.classList.add('eventTitle');
            spanTitle.appendChild(nodeTitle);
            stringTitle.push(cleanTitle);

            //get clean time
            let cleanTime = timeRegExp.exec(element);
            let spanTime = document.createElement("span");
            let nodeTime = document.createTextNode(cleanTime);
            spanTime.classList.add('eventTime');
            spanTime.appendChild(nodeTime);
            stringTime.push(cleanTime);

            let pDetails = document.createElement("p");
            pDetails.appendChild(spanTitle);
            pDetails.appendChild(spanTime);
            pDetails.classList.add('eventDetail');
            event.appendChild(pDetails);

            // console.log(event);
            // return eventTitle, eventTime
        });
        //put dos list into html
        list.matchGood.forEach(element => {
            // let cleanElem = (element.toLowerCase()).replace('+', '+');
            let p = document.createElement("p");
            let node = document.createTextNode(element);
            p.classList.add('inline');
            p.classList.add('doLists');
            p.appendChild(node);
            dos.appendChild(p);
        });
        //put donts list into html
        list.matchBad.forEach(element => {
            // let cleanElem = (element.toLowerCase()).replace('+', '-');
            let p = document.createElement("p");
            let node = document.createTextNode(element);
            p.classList.add('inline');
            p.classList.add('dontLists');
            p.appendChild(node);
            donts.appendChild(p);
        });
        //put score into html
        let p = document.createElement("p");
        let nodeScore = document.createTextNode(list.score);
        p.classList.add('inline');
        p.classList.add('score');
        p.appendChild(nodeScore);
        performance.appendChild(p);

        readAnalysis();
        recordTTS();
    });

    //read out loud
    let synth = window.speechSynthesis;

    if ('speechSynthesis' in window) {
        var synthesis = window.speechSynthesis;
    } else {
        console.log('Text-to-speech not supported.');
    }

    const readAnalysis = () => {
        let scoreVal = document.querySelector('.score').innerText;
        let saythis = '';
        //bad
        if (scoreVal < 0) {
            saythis =
                `Oh no! The world seems to be against you today. Watch out for your ${stringTitle.length} scheduled event. ${stringTitle}`;
            console.log('baddd');
        } else if (scoreVal = 0) {
            saythis =
                `Today is just another ordinary day, nothing too special or unusual. You should have pretty standard performance on your ${stringTitle.length} scheduled event. ${stringTitle}`
            console.log('neutral')
        } else {
            saythis =
                `What a lovely day! Expect tremendous outcome on your ${stringTitle.length} scheduled event. ${stringTitle}`
            console.log('good');
        }

        let speakTxt = new SpeechSynthesisUtterance(saythis);

        speakTxt.onend = e => {
            console.log('done speaking');
            stopTTS();
        }
        speakTxt.onerror = e => {
            console.error(e);
        }
        //select a default voice
        // speakTxt.voice = "Alex";
        speakTxt.lang = "en-US"; //zh-TW,ja-JP,en-GB, en-US
        //select pitch and rate
        speakTxt.rate = 1;
        speakTxt.pitch = 1;

        synth.speak(speakTxt);
    }

    //record this speech
    let audio = document.getElementById('audio');
    let state = false;
    let newRecording;
    let constraints = {
        audio: true
    }
    let recordedChunks = [];

    function recordTTS() {
        newRecording.start();
        // console.log('starting to record');
        // console.log(newRecording.state);
    }

    function stopTTS() {
        newRecording.stop();
        // console.log('recorder stopped');
        // console.log(newRecording.state);
    }

    function loopRecording() {
        let myAnalysis = document.getElementById('myAnalysis');
        console.log(myAnalysis)
        myAnalysis.play();
    }

    function setStream(mediaStream) {
        newRecording = new MediaRecorder(mediaStream);
        newRecording.onstart = function (e) {

        }
        newRecording.onstop = function (e) {
            // console.log("data available after MediaRecorder.stop() called.");
            var blob = new Blob(recordedChunks, {
                'type': 'audio/wav; codecs=opus'
            });
            recordedChunks = [];
            var audioURL = URL.createObjectURL(blob);
            let createAudio = document.createElement('audio');
            createAudio.src = audioURL;
            createAudio.setAttribute('id', 'myAnalysis');
            createAudio.setAttribute('controls', '');
            console.log(audioURL);
            audio.appendChild(createAudio);
            //save the wav to file system -> backend
            socket.emit('recordFile', audioURL);

        }
        newRecording.ondataavailable = function (e) {
            recordedChunks.push(e.data);
        }
    }


    // Prompt the user for permission, get the stream
    navigator.mediaDevices.getUserMedia(constraints)
        .then(setStream)
        .catch(function (err) {
            console.error(err);
        });
</script>
<style>
    * {
        font-family: 'Crimson Text', serif;
    }

    #fortune {
        max-width: 640px;
        margin: 0 auto;
    }

    .inline {
        display: inline-block;
        font-size: 48px;
        font-weight: 600;
        margin: 0 25px;
    }

    .doLists {
        color: teal;
    }

    .dontLists {
        color: tomato;
    }

    .txtCenter {
        text-align: center;
    }

    .section {
        margin: 50px;
    }

    .section p {
        margin: 0 15px;
    }

    .eventTitle::after {
        content: ' at ';
    }
</style>


<script>
</script>

</html>